<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Configurador POS</title>
    <style>
        :root {
            --gold: #bda46c;
            --black: #111;
            --white: #fff;
            --neron-bg: rgb(34, 34, 34);
        }

        body {
            font-family: sans-serif;
            background:var(--neron-bg);
            color: white;
            padding: 20px;
        }

        h2 {
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
        }

        .editor-section {
            margin-bottom: 40px;
        }

        /* Grid visual */
        .config-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .config-grid.vertical {
            display: grid;
            grid-template-columns: repeat(8, minmax(100px, 1fr));
            justify-self:flex-end;
        }

        .config-grid.opciones {
            display: grid;
            grid-template-columns: repeat(5, minmax(100px, 1fr));
            justify-self:center;
        }

        .slot {
            width: 100px;
            height: 80px;
            background: #333;
            border: 2px dashed #555;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            text-align: center;
            font-size: 12px;
        }

        .slot:hover {
            background: #444;
            border-color: #fff;
        }

        .slot .num {
            position: absolute;
            top: 2px;
            left: 5px;
            color: #777;
            font-size: 10px;
        }

        .slot.filled {
            background: var(--gold);
            color: black;
            border-style: solid;
            font-weight: bold;
        }

        button.save-btn{
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            
        }

        button.reset-btn{
            background: #435ef3;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            position: fixed;
            bottom: 20px;
        }

        /* Modal simple */
        #selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(90px, 1fr));
            gap: 10px;
            }

        .selector-grid .option-btn {
            height: 90px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--gold);
        }

        .selector-grid img {
            max-width: 40px;
            max-height: 40px;
            margin-bottom: 5px;
        }
        
        .option-btn.selected {
            outline: 3px solid #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.25);
            background: #dff5e5;
        }


        .modal-content {
            background: #fff;
            color: #000;
            padding: 20px;
            width:auto;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 8px;
        }

        .view-toggle{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            margin-bottom:10px;
            color:#000;
            font-weight:bold;
        }

            .switch{
            position:relative;
            display:inline-block;
            width:54px;
            height:25px;
        }

            .switch input{
            opacity:0;
            width:0;
            height:0;
        }

            .slider{
            position:absolute;
            cursor:pointer;
            top:0; left:0; right:2px; bottom:0;
            background:#ccc;
            transition:.2s;
            border-radius:25px;
        }

            .slider:before{
            position:absolute;
            content:"";
            height:17px;
            width:17px;
            left:4px;
            top:4px;
            background:white;
            transition:.2s;
            border-radius:50%;
        }

        .switch input:checked + .slider{
            background:#435ef3;
        }

        .switch input:checked + .slider:before{
            transform: translateX(26px);
        }


        .option-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #eee;
            border: 1px solid #ccc;
            cursor: pointer;
            text-align: center;
        }

        .option-btn:hover {
            background: #ddd;
        }

        .selector-list{
            max-width: 500px;
        }
    </style>
</head>

<body>

    <h1>üîß Configurador de Pantalla</h1>
    <p>Haz clic en un recuadro para asignar un bot√≥n. Usa "VAC√çO" para dejar un hueco.</p>

    <div class="editor-section">
        <h2>Barra Superior (Toolbar)</h2>
        <div class="config-grid" id="grid-top"></div>
    </div>

    <div class="editor-section">
        <h2>Panel Lateral (Pagos)</h2>
        <div class="config-grid vertical" id="grid-side"></div>
    </div>

     <div class="editor-section">
        <h2>Opciones</h2>
        <div class="config-grid opciones" id="grid-bot"></div>
    </div>

    <button class="reset-btn" onclick="resetBtns()">RESET</button>

    <button class="save-btn" onclick="saveConfig()">üíæ GUARDAR CAMBIOS</button>

    <div id="selector-modal">
        <div class="modal-content">
            <h3>Elige un bot√≥n para la posici√≥n <span id="current-slot-num"></span></h3>
            <div class="view-toggle">
                <span>üìã Lista</span>

                <label class="switch">
                    <input type="checkbox" id="viewToggle" onchange="onToggleView(this.checked)">
                    <span class="slider"></span>
                </label>

                <span>üß© Botones</span>
            </div>

            <div id="options-list" class="selector-list"></div>
            <button onclick="closeModal()" style="margin-top:10px; padding:10px; width:100%">Cancelar</button>
        </div>
    </div>

    <script src="data.js"></script>
    <script>

        let selectorView = 'list'; // 'list' | 'grid'

        // Cargar configuraci√≥n existente o usar defecto
        let currentConfig = JSON.parse(localStorage.getItem('neronPosConfig')) || JSON.parse(JSON.stringify(DEFAULT_LAYOUT));
        let activeSlot = { list: null, index: null };

        // Renderizar grids
        function initEditor() {
            renderGrid('grid-top', currentConfig.topBar, 'topBar', 12); // 12 huecos arriba
            renderGrid('grid-side', currentConfig.sidePanel, 'sidePanel', 16); // 16 huecos lado
            renderGrid( 'grid-bot', currentConfig.options, 'options', 30)
        }

        function renderGrid(domId, dataArray, arrayName, maxSlots) {
            const container = document.getElementById(domId);
            container.innerHTML = '';

            for (let i = 0; i < maxSlots; i++) {
                const key = dataArray[i];
                const btnData = MASTER_BUTTONS[key];

                const isLocked = (arrayName === 'topBar' && LOCKED_TOPBAR_KEYS.has(key));
                const isLockedOptions = (arrayName === 'options' && LOCKED_OPTIONS_KEYS.has(key));

                const div = document.createElement('div');
                div.className = (key ? 'slot filled' : 'slot') + (isLocked || isLockedOptions ? ' locked' : '');
                div.innerHTML = `<span class="num">${i + 1}</span>
                                <span>${btnData ? btnData.label : '(Vac√≠o)'}</span>`;

                if (!isLocked && !isLockedOptions) {
                    div.onclick = () => openSelector(arrayName, i);
                }
                // if(!isLockedOptions){
                //     div.onclick = () => openSelector(arrayName, i);
                // }

                container.appendChild(div);
            }
        }


        function setSelectorView(view) {
            selectorView = view;
            renderSelector();
        }

        function onToggleView(isGrid) {
            selectorView = isGrid ? 'grid' : 'list';
            renderSelector();
        }


        // Abrir selector
        function openSelector(listName, index) {
            activeSlot = { list: listName, index };
            document.getElementById('current-slot-num').innerText = index + 1;
            document.getElementById('viewToggle').checked = (selectorView === 'grid');
            renderSelector();
            document.getElementById('selector-modal').style.display = 'flex';
        }


        function renderSelector() {
            const list = document.getElementById('options-list');
            const { list: listName, index } = activeSlot;

            const currentKey = currentConfig[listName][index] || null;
            const availableKeys = getAvailableKeys();

            list.className = selectorView === 'grid'
                ? 'selector-grid'
                : 'selector-list';

            list.innerHTML = `
                <button class="option-btn" onclick="selectItem(null)">
                üö´ (DEJAR VAC√çO)
                </button>
            `;

            availableKeys.forEach(key => {
                list.innerHTML += renderOptionBtn(key, MASTER_BUTTONS[key], currentKey);
            });
        }

        function renderOptionBtn(key, btn, currentKey) {
            const isSelected = key === currentKey;
            const selectedClass = isSelected ? 'selected' : '';

            if (selectorView === 'grid') {
                return `
                <button class="option-btn ${selectedClass}" onclick="selectItem('${key}')">
                    ${btn.img ? `<img src="${btn.img}" alt="${btn.label}">` : ''}
                    <div>${btn.label}</div>
                </button>
                `;
            }

            // modo lista
            return `
                <button class="option-btn ${selectedClass}" onclick="selectItem('${key}')">
                <b>${btn.label}</b>
                </button>
            `;
        }


        function selectItem(key) {
            const currentKey = currentConfig[activeSlot.list][activeSlot.index] || null;

            
            // Bloqueo absoluto: esos botones no se quitan del topBar
            if (activeSlot.list === 'topBar' && LOCKED_TOPBAR_KEYS.has(currentKey)) {
                alert('‚õî Ese bot√≥n no se puede quitar de la barra superior.');
                return;
            }


            if (key) {
                const available = new Set(getAvailableKeys(currentKey));
                if (!available.has(key)) {
                alert('‚õî Ese bot√≥n ya est√° usado en otro slot.');
                return;
                }
            }

            currentConfig[activeSlot.list][activeSlot.index] = key;
            closeModal();
            initEditor();
        }


        function closeModal() {
            document.getElementById('selector-modal').style.display = 'none';
        }

        function getUsedKeys(section, currentIndex) {
            const used = new Set();

            (currentConfig[section] || []).forEach((key, idx) => {
                if (!key) return;

                // ignoramos el slot que estamos editando
                if (idx === currentIndex) return;

                used.add(key);
            });

            return used;
        }



        function getAvailableKeys() {
            const { list, index } = activeSlot;
            const used = getUsedKeys(list, index);

            return Object.keys(MASTER_BUTTONS).filter(k => !used.has(k));
        }



        function saveConfig() {
            localStorage.setItem('neronPosConfig', JSON.stringify(currentConfig));
            alert('‚úÖ Configuraci√≥n guardada. Recarga la p√°gina del POS.');
        }
        function resetBtns() {
            currentConfig.topBar = [...DEFAULT_LAYOUT.topBar];
            currentConfig.sidePanel = [...DEFAULT_LAYOUT.sidePanel];
            currentConfig.options = [...DEFAULT_LAYOUT.options];

            localStorage.removeItem('neronPosConfig');
            initEditor();
        }



        initEditor();
    </script>
</body>

</html>